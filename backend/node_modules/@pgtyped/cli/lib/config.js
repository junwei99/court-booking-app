/** @fileoverview Config file parser */
import { createRequire } from 'module';
import * as Either from 'fp-ts/lib/Either.js';
import { join, isAbsolute } from 'path';
import * as t from 'io-ts';
import { reporter } from 'io-ts-reporters';
import { default as dbUrlModule } from 'ts-parse-database-url';
// module import hack
const { default: parseDatabaseUri } = dbUrlModule;
const transformCodecProps = {
    include: t.string,
    /** @deprecated emitFileName is deprecated */
    emitFileName: t.union([t.string, t.undefined]),
    emitTemplate: t.union([t.string, t.undefined]),
};
const TSTransformCodec = t.type(Object.assign({ mode: t.literal('ts') }, transformCodecProps));
const SQLTransformCodec = t.type(Object.assign({ mode: t.literal('sql') }, transformCodecProps));
const TransformCodec = t.union([TSTransformCodec, SQLTransformCodec]);
const configParser = t.type({
    transforms: t.array(TransformCodec),
    srcDir: t.string,
    failOnError: t.union([t.boolean, t.undefined]),
    camelCaseColumnNames: t.union([t.boolean, t.undefined]),
    hungarianNotation: t.union([t.boolean, t.undefined]),
    dbUrl: t.union([t.string, t.undefined]),
    db: t.union([
        t.type({
            host: t.union([t.string, t.undefined]),
            password: t.union([t.string, t.undefined]),
            port: t.union([t.number, t.undefined]),
            user: t.union([t.string, t.undefined]),
            dbName: t.union([t.string, t.undefined]),
            ssl: t.union([t.UnknownRecord, t.boolean, t.undefined]),
        }),
        t.undefined,
    ]),
    typesOverrides: t.union([t.record(t.string, t.string), t.undefined]),
});
function merge(base, ...overrides) {
    return overrides.reduce((acc, o) => Object.entries(o).reduce((oAcc, [k, v]) => (v ? Object.assign(Object.assign({}, oAcc), { [k]: v }) : oAcc), acc), Object.assign({}, base));
}
function convertParsedURLToDBConfig({ host, password, user, port, database, }) {
    return {
        host,
        password,
        user,
        port,
        dbName: database,
    };
}
const require = createRequire(import.meta.url);
export function parseConfig(path, argConnectionUri) {
    var _a;
    const fullPath = isAbsolute(path) ? path : join(process.cwd(), path);
    const configObject = require(fullPath);
    const result = configParser.decode(configObject);
    if (Either.isLeft(result)) {
        const message = reporter(result);
        throw new Error(message[0]);
    }
    const defaultDBConfig = {
        host: '127.0.0.1',
        user: 'postgres',
        password: '',
        dbName: 'postgres',
        port: 5432,
    };
    const envDBConfig = {
        host: process.env.PGHOST,
        user: process.env.PGUSER,
        password: process.env.PGPASSWORD,
        dbName: process.env.PGDATABASE,
        port: process.env.PGPORT ? Number(process.env.PGPORT) : undefined,
        uri: (_a = process.env.PGURI) !== null && _a !== void 0 ? _a : process.env.DATABASE_URL,
    };
    const { db = defaultDBConfig, dbUrl: configDbUri, transforms, srcDir, failOnError, camelCaseColumnNames, hungarianNotation, typesOverrides, } = configObject;
    // CLI connectionUri flag takes precedence over the env and config one
    const dbUri = argConnectionUri || envDBConfig.uri || configDbUri;
    const urlDBConfig = dbUri
        ? convertParsedURLToDBConfig(parseDatabaseUri(dbUri))
        : {};
    if (transforms.some((tr) => !!tr.emitFileName)) {
        // tslint:disable:no-console
        console.log('Warning: Setting "emitFileName" is deprecated. Consider using "emitTemplate" instead.');
    }
    const finalDBConfig = merge(defaultDBConfig, db, urlDBConfig, envDBConfig);
    const parsedTypesOverrides = {};
    for (const [builtIn, mappedTo] of Object.entries(typesOverrides !== null && typesOverrides !== void 0 ? typesOverrides : {})) {
        parsedTypesOverrides[builtIn] = { name: mappedTo };
    }
    return {
        db: finalDBConfig,
        transforms,
        srcDir,
        failOnError: failOnError !== null && failOnError !== void 0 ? failOnError : false,
        camelCaseColumnNames: camelCaseColumnNames !== null && camelCaseColumnNames !== void 0 ? camelCaseColumnNames : false,
        hungarianNotation: hungarianNotation !== null && hungarianNotation !== void 0 ? hungarianNotation : true,
        typesOverrides: parsedTypesOverrides,
    };
}
//# sourceMappingURL=config.js.map